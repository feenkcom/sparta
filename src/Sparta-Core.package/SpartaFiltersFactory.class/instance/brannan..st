filters
brannan: aSurface
	|gradient extent vignetteCanvas sourceAfterCurves sourceBelow50 sourceAbove50
	arithmetic00 arithmetic10 arithmeticBlend overlayWithAlpha finalOverlay|
	extent := aSurface extent.
	
	gradient := canvas paint radialGradient
		stops: { 
			0.75 -> ((Color r: 169 g: 170 b: 152 range: 255) alpha: 0).
			1.0 -> (Color r: 138 g: 135 b: 116 range: 255) };
		innerCenter: extent / 2;
		outerRadius: extent max / 2.

	vignetteCanvas := canvas similar: extent.
	vignetteCanvas fill
		paint: gradient;
		path: (0@0 extent: extent);
		draw.
	
	sourceAfterCurves := canvas tableTransferFilter
		source: aSurface;
		disableRed: false;
		disableBlue: false;
		disableGreen: false;
		tableRed: #(0.1451 0.1451 0.1452 0.1452 0.1454 0.1456 0.1458 0.1461 0.1465 0.147 0.1476 0.1482 0.149 0.1498 0.1507 0.1518 0.1529 0.1542 0.1556 0.1571 0.1586 0.1604 0.1622 0.1641 0.1662 0.1683 0.1706 0.1729 0.1754 0.178 0.1807 0.1834 0.1863 0.1892 0.1923 0.1954 0.1985 0.2018 0.205 0.2084 0.2118 0.2143 0.2169 0.2195 0.2221 0.2247 0.2272 0.2298 0.2325 0.2351 0.2377 0.2404 0.243 0.2457 0.2485 0.2512 0.254 0.2569 0.2598 0.2627 0.2657 0.2688 0.2719 0.2751 0.2784 0.2823 0.2864 0.2904 0.2946 0.2989 0.3032 0.3076 0.3121 0.3167 0.3213 0.326 0.3308 0.3356 0.3405 0.3455 0.3505 0.3556 0.3608 0.3657 0.3708 0.3758 0.3809 0.3861 0.3913 0.3966 0.4019 0.4073 0.4127 0.4182 0.4238 0.4294 0.435 0.4408 0.4466 0.4525 0.4585 0.4645 0.4706 0.4773 0.4842 0.4911 0.4981 0.5052 0.5123 0.5196 0.5269 0.5342 0.5416 0.5491 0.5566 0.5641 0.5717 0.5792 0.5868 0.5945 0.6021 0.6097 0.6173 0.6249 0.6324 0.64 0.6475 0.6549 0.6615 0.6681 0.6746 0.6811 0.6876 0.694 0.7004 0.7068 0.7132 0.7195 0.7259 0.7322 0.7385 0.7448 0.7511 0.7574 0.7638 0.7701 0.7765 0.7835 0.7905 0.7975 0.8044 0.8113 0.8181 0.8248 0.8315 0.838 0.8444 0.8507 0.8568 0.8627 0.8679 0.8729 0.8777 0.8823 0.8867 0.8909 0.895 0.8989 0.9026 0.9061 0.9095 0.9128 0.9158 0.9188 0.9216 0.9244 0.9272 0.9298 0.9323 0.9347 0.937 0.9391 0.9412 0.9432 0.945 0.9468 0.9485 0.95 0.9515 0.9529 0.9542 0.9555 0.9566 0.9577 0.9587 0.9597 0.9605 0.9614 0.9621 0.9628 0.9635 0.9641 0.9647 0.9658 0.9668 0.9678 0.9688 0.9698 0.9707 0.9716 0.9725 0.9733 0.9742 0.975 0.9758 0.9765 0.9773 0.978 0.9787 0.9794 0.9801 0.9808 0.9814 0.982 0.9827 0.9833 0.9838 0.9844 0.985 0.9856 0.9861 0.9866 0.9872 0.9877 0.9882 0.9888 0.9893 0.9898 0.9903 0.9908 0.9913 0.9919 0.9924 0.9929 0.9934 0.994 0.9945 0.9951 0.9957 0.9962 0.9968 0.9974 0.998 0.9987 0.9993 1);
		tableGreen: #(0 0.0001 0.0005 0.0011 0.0019 0.003 0.0042 0.0056 0.0072 0.0089 0.0107 0.0127 0.0149 0.0171 0.0194 0.0219 0.0244 0.027 0.0297 0.0324 0.0352 0.038 0.0409 0.0438 0.0468 0.0497 0.0528 0.0558 0.0588 0.0619 0.065 0.068 0.0711 0.0742 0.0774 0.0805 0.0836 0.0867 0.0899 0.0931 0.0962 0.0994 0.1026 0.1059 0.1094 0.1129 0.1165 0.1201 0.1238 0.1275 0.1313 0.1351 0.139 0.143 0.147 0.151 0.1552 0.1594 0.1637 0.1681 0.1725 0.177 0.1816 0.1864 0.1912 0.1961 0.2017 0.2075 0.2134 0.2194 0.2256 0.2319 0.2383 0.2448 0.2515 0.2582 0.2651 0.2721 0.2792 0.2864 0.2937 0.3011 0.3086 0.3162 0.3239 0.3316 0.3395 0.3474 0.3555 0.3635 0.3717 0.3799 0.3882 0.3967 0.4052 0.4138 0.4224 0.431 0.4397 0.4484 0.4571 0.4658 0.4745 0.4832 0.4919 0.5006 0.5092 0.5178 0.5264 0.5349 0.5434 0.5518 0.5601 0.5683 0.5765 0.5841 0.5916 0.5991 0.6064 0.6136 0.6208 0.6278 0.6347 0.6416 0.6483 0.6549 0.6614 0.6678 0.6741 0.6802 0.6863 0.692 0.6976 0.7031 0.7084 0.7137 0.7188 0.7238 0.7287 0.7335 0.7383 0.7429 0.7474 0.7518 0.7562 0.7604 0.7646 0.7688 0.7728 0.7768 0.7807 0.7846 0.7884 0.7922 0.7964 0.8005 0.8047 0.8088 0.8128 0.8168 0.8208 0.8247 0.8286 0.8324 0.8362 0.84 0.8436 0.8473 0.8509 0.8544 0.8579 0.8613 0.8647 0.868 0.8713 0.8745 0.8778 0.881 0.8842 0.8873 0.8904 0.8934 0.8963 0.8991 0.9019 0.9046 0.9071 0.9097 0.9121 0.9144 0.9166 0.9188 0.9208 0.9228 0.9246 0.9263 0.9279 0.9294 0.9304 0.9312 0.9321 0.9328 0.9335 0.9342 0.9348 0.9354 0.9361 0.9367 0.9373 0.9386 0.9401 0.9416 0.9432 0.9449 0.9466 0.9484 0.9502 0.9521 0.954 0.9559 0.9579 0.9598 0.9618 0.9638 0.9658 0.9677 0.9696 0.9715 0.9734 0.9752 0.977 0.9787 0.9804 0.982 0.9835 0.9849 0.9862 0.9874 0.9884 0.9894 0.9902 0.9909 0.9914 0.9918 0.992 0.992 0.9918 0.9915 0.9909 0.9901 0.9891 0.9879 0.9864 0.9847 0.9827 0.9804);
		tableBlue: #(0.1373 0.1373 0.1376 0.138 0.1385 0.1392 0.14 0.1409 0.1419 0.1431 0.1443 0.1457 0.1471 0.1486 0.1501 0.1518 0.1535 0.1552 0.157 0.1589 0.1608 0.1627 0.1647 0.1667 0.1687 0.1707 0.1728 0.1748 0.1769 0.179 0.1811 0.1832 0.1853 0.1874 0.1895 0.1916 0.1936 0.1957 0.1978 0.1998 0.2019 0.2039 0.2058 0.2077 0.2096 0.2114 0.2133 0.2151 0.217 0.2188 0.2207 0.2225 0.2244 0.2264 0.2283 0.2303 0.2323 0.2344 0.2365 0.2387 0.241 0.2434 0.2458 0.2483 0.251 0.2548 0.2588 0.263 0.2672 0.2716 0.2762 0.2809 0.2857 0.2906 0.2956 0.3008 0.3061 0.3115 0.317 0.3225 0.3282 0.334 0.3399 0.3458 0.3518 0.3579 0.364 0.3702 0.3765 0.3821 0.3878 0.3935 0.3993 0.405 0.4107 0.4165 0.4223 0.428 0.4338 0.4396 0.4454 0.4511 0.4569 0.4627 0.4684 0.4742 0.4799 0.4856 0.4913 0.4969 0.5026 0.5082 0.5138 0.5193 0.5249 0.5303 0.5358 0.5412 0.5464 0.5516 0.5568 0.5619 0.567 0.572 0.577 0.5819 0.5867 0.5915 0.5963 0.601 0.6056 0.6102 0.6147 0.6191 0.6235 0.6278 0.632 0.6362 0.6402 0.6442 0.6482 0.652 0.6558 0.6595 0.6632 0.6667 0.6702 0.6736 0.6769 0.6802 0.6834 0.6865 0.6895 0.6924 0.6953 0.698 0.7003 0.7024 0.7045 0.7066 0.7087 0.7107 0.7127 0.7147 0.7167 0.7187 0.7207 0.7228 0.725 0.7271 0.7294 0.7326 0.7359 0.7393 0.7428 0.7464 0.75 0.7537 0.7575 0.7613 0.7651 0.769 0.7728 0.7767 0.7806 0.7845 0.7884 0.7923 0.7961 0.7992 0.8023 0.8053 0.8082 0.8112 0.8141 0.8169 0.8198 0.8226 0.8254 0.8281 0.8309 0.8336 0.8363 0.839 0.8417 0.8444 0.8471 0.8502 0.8533 0.8564 0.8596 0.8627 0.8658 0.8689 0.872 0.8751 0.8782 0.8813 0.8843 0.8873 0.8903 0.8932 0.8961 0.8989 0.9017 0.9045 0.9072 0.9098 0.9124 0.9149 0.9173 0.9196 0.9219 0.9241 0.9262 0.9282 0.9301 0.9319 0.9336 0.9352 0.9366 0.938 0.9392 0.9403 0.9412 0.942 0.9427 0.9432 0.9435 0.9437 0.9437 0.9436 0.9433 0.9428 0.9421 0.9412).
		
	sourceBelow50 := canvas tableTransferFilter
		source: sourceAfterCurves;
		disableRed: false;
		disableBlue: false;
		disableGreen: false;
		tableRed: #(0 0.0039 0.0078 0.0118 0.0157 0.0196 0.0235 0.0275 0.0314 0.0353 0.0392 0.0431 0.0471 0.051 0.0549 0.0588 0.0627 0.0667 0.0706 0.0745 0.0784 0.0824 0.0863 0.0902 0.0941 0.098 0.102 0.1059 0.1098 0.1137 0.1176 0.1216 0.1255 0.1294 0.1333 0.1373 0.1412 0.1451 0.149 0.1529 0.1569 0.1608 0.1647 0.1686 0.1725 0.1765 0.1804 0.1843 0.1882 0.1922 0.1961 0.2 0.2039 0.2078 0.2118 0.2157 0.2196 0.2235 0.2275 0.2314 0.2353 0.2392 0.2431 0.2471 0.251 0.2549 0.2588 0.2627 0.2667 0.2706 0.2745 0.2784 0.2824 0.2863 0.2902 0.2941 0.298 0.302 0.3059 0.3098 0.3137 0.3176 0.3216 0.3255 0.3294 0.3333 0.3373 0.3412 0.3451 0.349 0.3529 0.3569 0.3608 0.3647 0.3686 0.3725 0.3765 0.3804 0.3843 0.3882 0.3922 0.3961 0.4 0.4039 0.4078 0.4118 0.4157 0.4196 0.4235 0.4275 0.4314 0.4353 0.4392 0.4431 0.4471 0.451 0.4549 0.4588 0.4627 0.4667 0.4706 0.4745 0.4784 0.4824 0.4863 0.4902 0.4941 0.498 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0);
		tableGreen: #(0 0.0039 0.0078 0.0118 0.0157 0.0196 0.0235 0.0275 0.0314 0.0353 0.0392 0.0431 0.0471 0.051 0.0549 0.0588 0.0627 0.0667 0.0706 0.0745 0.0784 0.0824 0.0863 0.0902 0.0941 0.098 0.102 0.1059 0.1098 0.1137 0.1176 0.1216 0.1255 0.1294 0.1333 0.1373 0.1412 0.1451 0.149 0.1529 0.1569 0.1608 0.1647 0.1686 0.1725 0.1765 0.1804 0.1843 0.1882 0.1922 0.1961 0.2 0.2039 0.2078 0.2118 0.2157 0.2196 0.2235 0.2275 0.2314 0.2353 0.2392 0.2431 0.2471 0.251 0.2549 0.2588 0.2627 0.2667 0.2706 0.2745 0.2784 0.2824 0.2863 0.2902 0.2941 0.298 0.302 0.3059 0.3098 0.3137 0.3176 0.3216 0.3255 0.3294 0.3333 0.3373 0.3412 0.3451 0.349 0.3529 0.3569 0.3608 0.3647 0.3686 0.3725 0.3765 0.3804 0.3843 0.3882 0.3922 0.3961 0.4 0.4039 0.4078 0.4118 0.4157 0.4196 0.4235 0.4275 0.4314 0.4353 0.4392 0.4431 0.4471 0.451 0.4549 0.4588 0.4627 0.4667 0.4706 0.4745 0.4784 0.4824 0.4863 0.4902 0.4941 0.498 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0);
		tableBlue: #(0 0.0039 0.0078 0.0118 0.0157 0.0196 0.0235 0.0275 0.0314 0.0353 0.0392 0.0431 0.0471 0.051 0.0549 0.0588 0.0627 0.0667 0.0706 0.0745 0.0784 0.0824 0.0863 0.0902 0.0941 0.098 0.102 0.1059 0.1098 0.1137 0.1176 0.1216 0.1255 0.1294 0.1333 0.1373 0.1412 0.1451 0.149 0.1529 0.1569 0.1608 0.1647 0.1686 0.1725 0.1765 0.1804 0.1843 0.1882 0.1922 0.1961 0.2 0.2039 0.2078 0.2118 0.2157 0.2196 0.2235 0.2275 0.2314 0.2353 0.2392 0.2431 0.2471 0.251 0.2549 0.2588 0.2627 0.2667 0.2706 0.2745 0.2784 0.2824 0.2863 0.2902 0.2941 0.298 0.302 0.3059 0.3098 0.3137 0.3176 0.3216 0.3255 0.3294 0.3333 0.3373 0.3412 0.3451 0.349 0.3529 0.3569 0.3608 0.3647 0.3686 0.3725 0.3765 0.3804 0.3843 0.3882 0.3922 0.3961 0.4 0.4039 0.4078 0.4118 0.4157 0.4196 0.4235 0.4275 0.4314 0.4353 0.4392 0.4431 0.4471 0.451 0.4549 0.4588 0.4627 0.4667 0.4706 0.4745 0.4784 0.4824 0.4863 0.4902 0.4941 0.498 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0).
	
	sourceAbove50 := canvas tableTransferFilter
		source: sourceAfterCurves;
		disableRed: false;
		disableBlue: false;
		disableGreen: false;
		tableRed: #(0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.502 0.5059 0.5098 0.5137 0.5176 0.5216 0.5255 0.5294 0.5333 0.5373 0.5412 0.5451 0.549 0.5529 0.5569 0.5608 0.5647 0.5686 0.5725 0.5765 0.5804 0.5843 0.5882 0.5922 0.5961 0.6 0.6039 0.6078 0.6118 0.6157 0.6196 0.6235 0.6275 0.6314 0.6353 0.6392 0.6431 0.6471 0.651 0.6549 0.6588 0.6627 0.6667 0.6706 0.6745 0.6784 0.6824 0.6863 0.6902 0.6941 0.698 0.702 0.7059 0.7098 0.7137 0.7176 0.7216 0.7255 0.7294 0.7333 0.7373 0.7412 0.7451 0.749 0.7529 0.7569 0.7608 0.7647 0.7686 0.7725 0.7765 0.7804 0.7843 0.7882 0.7922 0.7961 0.8 0.8039 0.8078 0.8118 0.8157 0.8196 0.8235 0.8275 0.8314 0.8353 0.8392 0.8431 0.8471 0.851 0.8549 0.8588 0.8627 0.8667 0.8706 0.8745 0.8784 0.8824 0.8863 0.8902 0.8941 0.898 0.902 0.9059 0.9098 0.9137 0.9176 0.9216 0.9255 0.9294 0.9333 0.9373 0.9412 0.9451 0.949 0.9529 0.9569 0.9608 0.9647 0.9686 0.9725 0.9765 0.9804 0.9843 0.9882 0.9922 0.9961 1);
		tableGreen: #(0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.502 0.5059 0.5098 0.5137 0.5176 0.5216 0.5255 0.5294 0.5333 0.5373 0.5412 0.5451 0.549 0.5529 0.5569 0.5608 0.5647 0.5686 0.5725 0.5765 0.5804 0.5843 0.5882 0.5922 0.5961 0.6 0.6039 0.6078 0.6118 0.6157 0.6196 0.6235 0.6275 0.6314 0.6353 0.6392 0.6431 0.6471 0.651 0.6549 0.6588 0.6627 0.6667 0.6706 0.6745 0.6784 0.6824 0.6863 0.6902 0.6941 0.698 0.702 0.7059 0.7098 0.7137 0.7176 0.7216 0.7255 0.7294 0.7333 0.7373 0.7412 0.7451 0.749 0.7529 0.7569 0.7608 0.7647 0.7686 0.7725 0.7765 0.7804 0.7843 0.7882 0.7922 0.7961 0.8 0.8039 0.8078 0.8118 0.8157 0.8196 0.8235 0.8275 0.8314 0.8353 0.8392 0.8431 0.8471 0.851 0.8549 0.8588 0.8627 0.8667 0.8706 0.8745 0.8784 0.8824 0.8863 0.8902 0.8941 0.898 0.902 0.9059 0.9098 0.9137 0.9176 0.9216 0.9255 0.9294 0.9333 0.9373 0.9412 0.9451 0.949 0.9529 0.9569 0.9608 0.9647 0.9686 0.9725 0.9765 0.9804 0.9843 0.9882 0.9922 0.9961 1);
		tableBlue: #(0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.502 0.5059 0.5098 0.5137 0.5176 0.5216 0.5255 0.5294 0.5333 0.5373 0.5412 0.5451 0.549 0.5529 0.5569 0.5608 0.5647 0.5686 0.5725 0.5765 0.5804 0.5843 0.5882 0.5922 0.5961 0.6 0.6039 0.6078 0.6118 0.6157 0.6196 0.6235 0.6275 0.6314 0.6353 0.6392 0.6431 0.6471 0.651 0.6549 0.6588 0.6627 0.6667 0.6706 0.6745 0.6784 0.6824 0.6863 0.6902 0.6941 0.698 0.702 0.7059 0.7098 0.7137 0.7176 0.7216 0.7255 0.7294 0.7333 0.7373 0.7412 0.7451 0.749 0.7529 0.7569 0.7608 0.7647 0.7686 0.7725 0.7765 0.7804 0.7843 0.7882 0.7922 0.7961 0.8 0.8039 0.8078 0.8118 0.8157 0.8196 0.8235 0.8275 0.8314 0.8353 0.8392 0.8431 0.8471 0.851 0.8549 0.8588 0.8627 0.8667 0.8706 0.8745 0.8784 0.8824 0.8863 0.8902 0.8941 0.898 0.902 0.9059 0.9098 0.9137 0.9176 0.9216 0.9255 0.9294 0.9333 0.9373 0.9412 0.9451 0.949 0.9529 0.9569 0.9608 0.9647 0.9686 0.9725 0.9765 0.9804 0.9843 0.9882 0.9922 0.9961 1).
		
	"compute the 'low' part, b<0.5 ==> c=2ab"
	arithmetic00 := canvas arithmeticCombineFilter
		source: sourceBelow50;
		secondSource: vignetteCanvas;
		coefficients: { 2 . 0 . 0 . 0 }.
		
	"compute the 'high' part, b>0.5 ==> c=1-2(1-a)(1-b)=-2ab+2a+2b-1"
	arithmetic10 := canvas arithmeticCombineFilter
		source: sourceAbove50;
		secondSource: vignetteCanvas;
		coefficients: { -2 . 2 . 2 . -1 }.

	"combine high and low"
	arithmeticBlend := canvas arithmeticCombineFilter
		source: arithmetic00;
		secondSource: arithmetic10;
		coefficients: { 0 . 1 . 1 . 0 }.

	"re-apply alpha of vignette on blended result"
	overlayWithAlpha := canvas compositeFilter
		in;
		source: vignetteCanvas;
		source: arithmeticBlend.
		
	finalOverlay := canvas compositeFilter
		atop;
		source: sourceAfterCurves;
		source: overlayWithAlpha.	

	^ canvas colorMatrixFilter
		source: finalOverlay;
		matrix: #(
			0.52756 0.42912 0.04332 0 0
			0.12756 0.82912 0.04332 0 0
			0.12756 0.42912 0.44332 0 0
			0 0 0 1 0)